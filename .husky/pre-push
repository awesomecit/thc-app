#!/usr/bin/env sh

# Get the remote branch being pushed to
remote="$1"
url="$2"

# Check if pre-push checks should be skipped
if [ "$SKIP_PRE_PUSH_CHECKS" = "true" ]; then
  echo "âš ï¸  SKIP_PRE_PUSH_CHECKS=true - bypassing all checks"
  echo "ğŸ’¡ Use with caution - CI/CD will still verify"
  exit 0
fi

# Read stdin to get local_ref, local_sha, remote_ref, remote_sha
while read local_ref local_sha remote_ref remote_sha; do
  # Extract branch name from remote_ref (refs/heads/main -> main)
  branch=$(echo "$remote_ref" | sed 's|^refs/heads/||')
  
  # If branch is empty (shouldn't happen), exit gracefully
  if [ -z "$branch" ]; then
    echo "âš ï¸  Could not determine branch name - skipping checks"
    exit 0
  fi
  
  # Only run verification when pushing to main or master
  if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
    echo "ğŸ” Pushing to protected branch: $branch"
    echo ""
    
    # Build verification
    echo "ğŸ—ï¸  Step 1/2: Running build verification..."
    npm run build
    
    if [ $? -ne 0 ]; then
      echo "âŒ Build failed! Push blocked."
      echo "ğŸ’¡ Fix compilation errors before pushing to $branch"
      echo "ğŸ’¡ To skip: SKIP_PRE_PUSH_CHECKS=true git push"
      exit 1
    fi
    echo "âœ… Build successful"
    echo ""
    
    # Test verification
    echo "ğŸ§ª Step 2/2: Running test suite..."
    npm test
    
    if [ $? -ne 0 ]; then
      echo "âŒ Tests failed! Push blocked."
      echo "ğŸ’¡ Fix failing tests before pushing to $branch"
      echo "ğŸ’¡ To skip: SKIP_PRE_PUSH_CHECKS=true git push"
      exit 1
    fi
    echo "âœ… All tests passed"
    echo ""
    
    echo "âœ… All checks passed - push allowed"
  else
    echo "âš¡ Pushing to feature branch: $branch - skipping pre-push checks"
    echo "ğŸ’¡ CI/CD will verify on pull request"
  fi
done

exit 0
